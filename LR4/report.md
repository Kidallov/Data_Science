# **Отчёт по лабораторной работе №4**

## **Прогнозирование товарооборота книжного интернет-магазина**

---

## **1. Цель работы**

Целью лабораторной работы является построение, анализ и сравнение различных моделей прогнозирования объёмов заказов книжного интернет-магазина.
Прогнозирование позволяет оптимизировать управление складскими запасами, планирование персонала и снизить издержки, связанные с колебаниями спроса.

---

## **2. Исходные данные**

* **Датасет:** `tovar_moving.csv`
* **Описание:** содержит два столбца:

  * `date` — дата оформления заказов;
  * `qty` — количество заказанных книг в день.

---

## **3. Предобработка данных**

1. **Загрузка данных:**
   Данные загружаются из CSV-файла, с автоматическим преобразованием столбца `date` в формат даты и установкой его как индекса.

2. **Преобразование типов:**
   Столбец `qty` приводится к числовому формату, при ошибках преобразования значения заменяются на `NaN`.

3. **Обработка пропусков:**
   Пропущенные значения интерполируются по времени, оставшиеся — заполняются соседними значениями.

4. **Установка частоты ряда:**
   Временной ряд переводится к ежедневной частоте (`'D'`).

5. **Разделение выборки:**
   Последнее наблюдение откладывается для тестирования (оценка точности прогноза на один шаг вперёд).

---

## **4. Логарифмическая трансформация**

Для стабилизации дисперсии и улучшения поведения моделей используется **логарифмическое преобразование**:

$$
\text{log_qty} = \log(1 + \text{qty})
$$

Преобразование выполняется с помощью функции `np.log1p`, что предотвращает ошибки при наличии нулевых значений.
После прогнозирования результаты возвращаются в исходную шкалу с помощью `np.expm1`.

> Пример вывода:
> `qty = 170665.00 → log_qty = 12.05`

---

## **5. Анализ временного ряда**

1. **Разложение временного ряда:**
   Выполнено разложение с недельной сезонностью (`period=7`).
   В результате получены и визуализированы:

   * трендовая компонента;
   * сезонная компонента;
   * остатки.

2. **ACF и PACF:**
   Для логарифмированного ряда построены графики автокорреляционной (ACF) и частичной автокорреляционной (PACF) функций.
   Это позволило определить наличие сезонности и возможные порядки AR и MA для SARIMA.

---

## **6. Моделирование и прогнозирование**

В работе реализованы и протестированы две модели:

---

### **1. Экспоненциальное сглаживание (Holt–Winters)**

* Модель:
  `ExponentialSmoothing` с параметрами
  `trend='add'`, `seasonal='add'`, `seasonal_periods=7`
* Прогноз выполняется на **1 день вперёд**.
* Модель обучается на логарифмированных данных.
* Прогноз переводится обратно в исходную шкалу (`expm1`).
* Метрики: RMSE и MAE на одном отложенном наблюдении.

---

### **2. SARIMA (сезонная ARIMA)**

* При наличии библиотеки `pmdarima` используется `auto_arima` для автоматического подбора параметров `(p, d, q)` и `(P, D, Q, s)`.
  В данном случае библиотека не была установлена, поэтому использованы **дефолтные параметры**:
  $$
  (p, d, q) = (1, 1, 0), \quad (P, D, Q, s) = (0, 1, 1, 7)
  $$
* Прогноз выполняется на 1 шаг вперёд с обратным преобразованием шкалы.
* Вычислены метрики RMSE и MAE.

---

## **7. Анализ остатков**

Для обеих моделей проведён анализ остатков:

* построены **ряды остатков**;
* визуализированы **ACF остатков**, чтобы проверить отсутствие автокорреляции;
* построен **Q–Q plot** для проверки нормальности распределения ошибок.

> Остатки обеих моделей распределены случайно, что подтверждает адекватность аппроксимации.

---

## **8. Сравнение моделей и результаты**

Результаты прогнозирования и ошибки сохранены в файл **`forecast_results.csv`**
в следующем формате:

| model                        | forecast_qty | true_qty  | RMSE_onepoint | MAE_onepoint |
| ---------------------------- | ------------ | --------- | ------------- | ------------ |
| HoltWinters                  | 379968.36    | 423846.00 | 43877.64      | 43877.64     |
| SARIMA(1, 1, 0)x(0, 1, 1, 7) | 271095.18    | 423846.00 | 152750.82     | 152750.82    |

Пример вывода в консоль:

```
=== Прогноз на одно отложенное наблюдение ===
HoltWinters: прогноз=379968.36, RMSE=43877.64
SARIMA(1, 1, 0)x(0, 1, 1, 7): прогноз=271095.18, RMSE=152750.82
```

> В данном примере модель **Holt–Winters** показала более низкую ошибку (лучшее качество прогноза).

---

## **9. Визуализация прогнозов**

На итоговом графике показаны:

* последние 60 дней фактических данных (`qty`);
* тестовая точка (чёрная метка);
* прогноз Holt–Winters (оранжевая точка);
* прогноз SARIMA (зелёная точка);
* графики остатков для обеих моделей.

Графики позволяют наглядно оценить, как модели продолжают тенденцию временного ряда и насколько точно предсказывают последнюю точку.

---

## **10. Выводы**

1. Применение **логарифмической трансформации** стабилизировало дисперсию и улучшило устойчивость моделей.
2. **Модель Holt–Winters** показала наилучшее качество прогноза в рамках данной выборки.
3. Остатки моделей ведут себя как случайный шум, что подтверждает их адекватность.
4. Использование `auto_arima` (при наличии) позволяет упростить настройку SARIMA и повысить точность прогнозов.
5. Сохранение результатов в `forecast_results.csv` облегчает последующий анализ и сравнение моделей.

---

### ✅ Скрипт успешно завершён

```
Результаты сохранены в файл: forecast_results.csv
Скрипт успешно завершён ✅
```

---
